<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Esquiva Mangonio</title>
  <style>
    body { margin: 0; background: #def; overflow: hidden; }
    canvas { display: block; margin: auto; background: #b2ebf2; border: 5px solid #333; }
    #gameOver, #winMessage, #levelComplete {
      position: absolute; top: 30%; width: 100%; text-align: center;
      font-size: 2em; color: red; display: none;
      user-select: none;
    }
    #winMessage { color: purple; }
    #levelComplete { color: green; }
    #score { position: absolute; top: 10px; left: 20px; font-size: 20px; font-weight: bold; user-select: none; }
    #hydrationBar {
      position: absolute; bottom: 10px; right: 10px;
      width: 100px; height: 10px; border: 2px solid #000; background: #ccc;
    }
    #hydrationLevel { height: 100%; background: blue; width: 100%; }
    #controlsInfo {
      position: absolute; bottom: 50px; left: 10px;
      font-size: 14px; background: rgba(255,255,255,0.7); padding: 4px 8px; border-radius: 5px;
      user-select: none;
    }
    #skinSelector {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      font-size: 16px; padding: 8px;
    }
    #levelSelect {
      display: none; position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); background: white; border: 3px solid #222;
      padding: 20px; text-align: center; box-shadow: 0 0 15px rgba(0,0,0,0.5);
      user-select: none;
    }
    #levelSelect button { margin: 5px; font-size: 16px; padding: 10px 20px; }
  </style>
</head>
<body>
  <div id="gameOver">Haz muerto, Mangonio está muy triste 😭<br>Presiona "R" para reiniciar</div>
  <div id="winMessage">Felicidades Completaste todos los niveles 🎂<br>Elige otro nivel abajo</div>
  <div id="levelComplete">Nivel completado 👽<br>Presiona "T" para el siguiente nivel</div>
  <div id="score">Puntos: 0</div>
  <div id="hydrationBar"><div id="hydrationLevel"></div></div>
  <div id="controlsInfo">B = agacharse • T = siguiente nivel (al completarlo) • R = reiniciar</div>
  <select id="skinSelector">
    <option value="mangonio.png">Mangonio</option>
    <option value="mangoniofino.png">Mangonio Fino</option>
    <option value="René.png">René</option>
  </select>
  <div id="levelSelect"><h2>Selecciona un nivel</h2><div id="levelButtons"></div></div>
  <canvas id="game" width="800" height="300"></canvas>

  <script>
    const canvas = document.getElementById("game"), ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score"),
          gameOverEl = document.getElementById("gameOver"),
          winEl = document.getElementById("winMessage"),
          lvlCompEl = document.getElementById("levelComplete"),
          hdLvlEl = document.getElementById("hydrationLevel"),
          skinSel = document.getElementById("skinSelector"),
          lvlSelDiv = document.getElementById("levelSelect"),
          lvlBtns = document.getElementById("levelButtons");

    const imgMang = new Image(), imgManzana = new Image(), imgAgua = new Image(), imgMM = new Image();
    imgManzana.src = "manzana.png"; 
    imgAgua.src = "Agua.png"; 
    imgMM.src = "EMANEMS.png";
    imgMang.src = skinSel.value;

    let level = 1, unlockedLevels = [1], mangonio, obstacles, speed, frame, score, gameOver = false, youWin = false;
    let canDouble = false, hydration = 100, crouch = false, jumps = 0;

    function resetGame() {
      mangonio = { x: 60, y: canvas.height - 60 - 60, w: 50, h: 70, vy: 0, gp: -13, g: 0.9, grd: true };
      obstacles = [];
      frame = 0;
      score = 0;
      gameOver = false;
      youWin = false;
      jumps = 0;

      // Velocidad ajustada para niveles 1 y 2 (15% menos)
      speed = (level <= 2 ? 3.5 * 0.85 : 6);
      canDouble = level >= 4;
      hydration = level >= 3 ? 100 : 0;
      scoreEl.textContent = `Puntos: 0`; 
      gameOverEl.style.display = winEl.style.display = lvlCompEl.style.display = "none";
      hdLvlEl.style.width = hydration + "%"; 
      hdLvlEl.parentElement.style.display = level >= 3 ? "block" : "none";

      requestAnimationFrame(update);
    }

    document.addEventListener("keydown", e => {
      if(e.code == "Space" && (mangonio.grd || (canDouble && jumps < 2)) && !gameOver && !youWin){
        mangonio.vy = mangonio.gp;
        mangonio.grd = false;
        jumps++;
      }
      if(e.key == "b" || e.key == "B"){
        crouch = true; 
        mangonio.h = 40;
      }
      if((e.key == "r" || e.key == "R") && (gameOver || youWin)){
        resetGame();
      }
      if(e.key == "t" || e.key == "T"){
        if(youWin && level < 5){
          level++;
          if(!unlockedLevels.includes(level)) unlockedLevels.push(level);
          resetGame();
        } else if(youWin && level == 5){
          showLevelSelect();
        }
      }
    });

    document.addEventListener("keyup", e => {
      if(e.key == "b" || e.key == "B"){
        crouch = false;
        mangonio.h = 70;
      }
    });

    skinSel.addEventListener("change", () => {
      imgMang.src = skinSel.value;
    });
    imgMang.onload = () => resetGame();

    function showLevelSelect(){
      lvlSelDiv.style.display = "block"; 
      lvlBtns.innerHTML = "";
      unlockedLevels.forEach(lvl => {
        const b = document.createElement("button");
        b.textContent = "Nivel " + lvl;
        b.onclick = () => { level = lvl; lvlSelDiv.style.display = "none"; resetGame(); };
        lvlBtns.appendChild(b);
      });
    }

    function drawFloor() {
      ctx.fillStyle = "#f5deb3";
      ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
    }

    function drawMang(){
      ctx.drawImage(imgMang, mangonio.x, mangonio.y, mangonio.w * (skinSel.value == "mangoniofino.png" ? 0.8 : 1), mangonio.h * (skinSel.value == "René.png" ? 0.9 : 1));
    }

    function drawCactus(c){
      // Cactus 1/4 más pequeño
      ctx.fillStyle = "#2e8b57";
      ctx.fillRect(c.x, c.y, c.w * 0.75, c.h * 0.75);
      // Podrías agregar detalles aquí si quieres
    }

    function drawManzana(m){
      ctx.drawImage(imgManzana, m.x, m.y, m.w, m.h);
    }

    function drawAgua(a){
      ctx.drawImage(imgAgua, a.x, a.y, 20, 30);
    }

    function drawMM(x){
      ctx.drawImage(imgMM, x.x, x.y, 20, 20);
    }

    function update() {
      if(gameOver || youWin) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawFloor();

      mangonio.vy += mangonio.g;
      mangonio.y += mangonio.vy;
      if(mangonio.y >= canvas.height - 60 - mangonio.h){
        mangonio.y = canvas.height - 60 - mangonio.h;
        mangonio.vy = 0;
        mangonio.grd = true;
        jumps = 0;
      }
      drawMang();

      // Menos cactus en niveles 1 y 2, además son 1/4 más pequeños al dibujarlos (ajustado en drawCactus)
      if(frame % (level <= 2 ? 120 : 60) == 0){
        let obs = {x: canvas.width, y: canvas.height - 60 - 50, w: 20, h: 50, type: 'cactus'};
        if(level >= 2 && Math.random() < 0.3){
          obs.type = 'manzana'; obs.w = obs.h = 30; obs.y = 100;
        }
        obstacles.push(obs);
      }
      if(level >= 3 && obstacles.filter(o => o.type == 'cactus').length % 5 == 0 && Math.random() < 0.05)
        obstacles.push({x: canvas.width, y: canvas.height - 60 - 30, w: 20, h: 30, type: 'agua'});
      if(level >= 4 && Math.random() < 0.005)
        obstacles.push({x: canvas.width, y: canvas.height - 60 - 40, w: 20, h: 20, type: 'mm'});

      obstacles.forEach((o, i) => {
        o.x -= speed * (level == 4 && Math.random() < 0.5 ? 1.2 : 1);

        if(o.type == 'cactus') drawCactus(o);
        if(o.type == 'manzana') drawManzana(o);
        if(o.type == 'agua') drawAgua(o);
        if(o.type == 'mm') drawMM(o);

        if(mangonio.x < o.x + o.w && mangonio.x + mangonio.w > o.x && mangonio.y + mangonio.h > o.y){
          if(o.type == 'agua'){
            hydration = Math.min(100, hydration + 30);
            hdLvlEl.style.width = hydration + '%';
            obstacles.splice(i, 1);
          } else if(o.type == 'mm'){
            speed = Math.max(2, speed - 2);
            obstacles.splice(i, 1);
          } else {
            gameOver = true;
            // Mostrar mensaje de muerte según skin seleccionada
            switch(skinSel.value){
              case "mangonio.png":
                gameOverEl.textContent = `Haz muerto, Mangonio está muy triste 😭\nPresiona "R" para reiniciar`;
                break;
              case "mangoniofino.png":
                gameOverEl.textContent = `Haz muerto pero con estilo bro jijiji 🙉\nPresiona "R" para reiniciar`;
                break;
              case "René.png":
                gameOverEl.textContent = `René murió... pero siempre será el más guapo de la Nación 👦🏿\nPresiona "R" para reiniciar`;
                break;
              default:
                gameOverEl.textContent = `Haz muerto 😭\nPresiona "R" para reiniciar`;
            }
            gameOverEl.style.display = "block";
          }
        }
      });

      obstacles = obstacles.filter(o => o.x + o.w > 0);

      frame++;
      if(frame % 5 == 0){
        score++;
        scoreEl.textContent = `Puntos: ${score}`;
      }

      if(level >= 3){
        hydration -= 0.05;
        hdLvlEl.style.width = hydration + '%';
        if(hydration <= 0){
          gameOver = true;
          // También mostrar mensaje de muerte según skin (por hidratación)
          switch(skinSel.value){
            case "mangonio.png":
              gameOverEl.textContent = `Haz muerto, Mangonio está muy triste 😭\nPresiona "R" para reiniciar`;
              break;
            case "mangoniofino.png":
              gameOverEl.textContent = `Haz muerto pero con estilo bro jijiji 🙉\nPresiona "R" para reiniciar`;
              break;
            case "René.png":
              gameOverEl.textContent = `René murió... pero siempre será el más guapo de la Nación 👦🏿\nPresiona "R" para reiniciar`;
              break;
            default:
              gameOverEl.textContent = `Haz muerto 😭\nPresiona "R" para reiniciar`;
          }
          gameOverEl.style.display = "block";
        }
      }

      if(level >= 5){
        ctx.globalAlpha = 0.1 + Math.abs(Math.sin(frame / 100));
      } else ctx.globalAlpha = 1;

      // Ganar nivel al llegar a cierto puntaje (2000 puntos)
      if(score >= 2000){
        youWin = true;
        if(level < 5){
          lvlCompEl.style.display = "block";
          lvlCompEl.textContent = "Nivel completado 👽\nPresiona \"T\" para el siguiente nivel";
        } else {
          winEl.style.display = "block";
          winEl.textContent = "Felicidades Completaste todos los niveles 🎂\nElige otro nivel abajo";
        }
      } else {
        requestAnimationFrame(update);
      }
    }
  </script>
</body>
</html>
