<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Esquiva Mangonio</title>
  <style>
    body {
      margin: 0;
      background: #def;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
      margin: auto;
      background: #b2ebf2;
      border: 5px solid #333;
    }
    #gameOver, #winMessage {
      position: absolute;
      top: 30%;
      width: 100%;
      text-align: center;
      font-size: 2em;
      color: red;
      display: none;
    }
    #score, #coinsDisplay {
      position: absolute;
      top: 10px;
      font-size: 20px;
      font-weight: bold;
      background: whitecc;
      padding: 4px 8px;
      border-radius: 6px;
      user-select: none;
    }
    #score {
      left: 20px;
    }
    #coinsDisplay {
      left: 150px;
    }
    #skinSelector {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      padding: 8px;
    }
    #shopBtn {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 6px;
    }
    #shopModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      background: white;
      border: 2px solid #333;
      padding: 16px;
      display: none;
      z-index: 100;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    #shopModal h2 {
      margin-top: 0;
      margin-bottom: 12px;
    }
    .shopItem {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 6px;
    }
    .shopItem img {
      width: 40px;
      height: 56px;
      object-fit: contain;
      border: 1px solid #999;
    }
    .buyBtn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    .buyBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    #closeShopBtn {
      margin-top: 12px;
      padding: 6px 10px;
      background: #f44336;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="gameOver">Haz muerto, Mangonio estÃ¡ muy triste ðŸ˜­<br>Presiona "R" para reiniciar</div>
  <div id="winMessage">Ganaste, Mangonio estÃ¡ orgulloso ðŸ™‰<br>Puntaje mÃ¡ximo alcanzado</div>
  <div id="score">Puntos: 0</div>
  <div id="coinsDisplay">Monedas: 0</div>
  <select id="skinSelector">
    <option value="mangonio.png">Mangonio</option>
    <option value="mangoniofino.png">Mangonio Fino</option>
    <option value="RenÃ©.png">RenÃ©</option>
    <option value="gil.png">Gil</option>
    <option value="pablito.png">Pablito</option>
    <option value="kuchau.png">Kuchau</option>
    <option value="polariza.png">Polariza</option>
  </select>
  <button id="shopBtn">Tienda ðŸ›’</button>
  <canvas id="game" width="800" height="300"></canvas>

  <!-- Ventana tienda -->
  <div id="shopModal">
    <h2>Tienda de Skins</h2>
    <div id="shopItems"></div>
    <button id="closeShopBtn">Cerrar</button>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreDisplay = document.getElementById("score");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const gameOverText = document.getElementById("gameOver");
    const winMessage = document.getElementById("winMessage");
    const skinSelector = document.getElementById("skinSelector");
    const shopBtn = document.getElementById("shopBtn");
    const shopModal = document.getElementById("shopModal");
    const shopItemsDiv = document.getElementById("shopItems");
    const closeShopBtn = document.getElementById("closeShopBtn");

    const mangonioImg = new Image();
    mangonioImg.src = skinSelector.value;

    const goal = 2500;
    const floorHeight = 60;

    // Juego
    let mangonio, obstacles, speed, frame, score, gameOver, youWin;
    let speedStartTime = 0;

    // Monedas en el juego
    let coins = 0;
    let coinObjects = [];

    // Carga imagen moneda
    const coinImg = new Image();
    coinImg.src = "coin.png"; // Debes agregar esta imagen para la moneda

    // Datos tienda (skins + precio en monedas)
    const storeSkins = [
      {name: "Gil", img: "gil.png", price: 100, owned: false},
      {name: "Pablito", img: "pablito.png", price: 150, owned: false},
      {name: "Kuchau", img: "kuchau.png", price: 200, owned: false},
      {name: "Polariza", img: "polariza.png", price: 250, owned: false}
    ];

    // Iniciar juego
    function resetGame() {
      mangonio = {
        x: 60,
        y: canvas.height - floorHeight - 60,
        width: 50,
        height: 70,
        vy: 0,
        jumpPower: -13,
        gravity: 0.9,
        grounded: true
      };

      obstacles = [];
      coinObjects = [];
      speed = 6;
      frame = 0;
      score = 0;
      coins = coins; // mantiene las monedas acumuladas entre juegos
      gameOver = false;
      youWin = false;
      speedStartTime = performance.now();
      gameOverText.style.display = "none";
      winMessage.style.display = "none";
      scoreDisplay.textContent = "Puntos: 0";
      coinsDisplay.textContent = `Monedas: ${coins}`;

      requestAnimationFrame(update);
    }

    // Dibujar suelo
    function drawFloor() {
      ctx.fillStyle = "#f5deb3";
      ctx.fillRect(0, canvas.height - floorHeight, canvas.width, floorHeight);
    }

    // Dibujar jugador
    function drawMangonio() {
      ctx.drawImage(mangonioImg, mangonio.x, mangonio.y, mangonio.width, mangonio.height);
    }

    // Dibujar cactus
    function drawCactus(cactus) {
      ctx.fillStyle = "#2e8b57";
      ctx.fillRect(cactus.x, cactus.y, cactus.width, cactus.height);
      ctx.fillRect(cactus.x - 10, cactus.y + 10, 8, 20);
      ctx.fillRect(cactus.x + cactus.width, cactus.y + 10, 8, 20);
    }

    // Dibujar moneda
    function drawCoin(c) {
      ctx.drawImage(coinImg, c.x, c.y, c.size, c.size);
    }

    // Mostrar mensaje de victoria
    function drawWin() {
      ctx.font = "30px Arial";
      ctx.fillStyle = "purple";
      ctx.fillText("ðŸŽ‚", canvas.width / 2 - 15, canvas.height / 2);
      for (let i = 0; i < 100; i++) {
        ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
        ctx.beginPath();
        ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 3, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // FunciÃ³n principal de actualizaciÃ³n
    function update() {
      if (gameOver || youWin) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawFloor();

      // Actualizar jugador
      mangonio.vy += mangonio.gravity;
      mangonio.y += mangonio.vy;

      if (mangonio.y >= canvas.height - floorHeight - mangonio.height) {
        mangonio.y = canvas.height - floorHeight - mangonio.height;
        mangonio.vy = 0;
        mangonio.grounded = true;
      }

      drawMangonio();

      // Crear obstÃ¡culos
      if (frame % 60 === 0) {
        obstacles.push({
          x: canvas.width,
          y: canvas.height - floorHeight - 50,
          width: 20,
          height: 50
        });
      }

      // Crear monedas aleatorias (1 moneda cada 150 frames aprox)
      if (frame % 150 === 0) {
        coinObjects.push({
          x: canvas.width,
          y: canvas.height - floorHeight - 30,
          size: 30
        });
      }

      // Mover y dibujar obstÃ¡culos
      for (let i = 0; i < obstacles.length; i++) {
        let c = obstacles[i];
        c.x -= speed;
        drawCactus(c);

        // ColisiÃ³n con jugador -> Game Over
        if (
          mangonio.x < c.x + c.width &&
          mangonio.x + mangonio.width > c.x &&
          mangonio.y + mangonio.height > c.y
        ) {
          gameOver = true;
          gameOverText.style.display = "block";
          return;
        }
      }

      obstacles = obstacles.filter(c => c.x + c.width > 0);

      // Mover y dibujar monedas
      for (let i = 0; i < coinObjects.length; i++) {
        let coin = coinObjects[i];
        coin.x -= speed;
        drawCoin(coin);

        // ColisiÃ³n con jugador -> recoger moneda
        if (
          mangonio.x < coin.x + coin.size &&
          mangonio.x + mangonio.width > coin.x &&
          mangonio.y + mangonio.height > coin.y &&
          mangonio.y < coin.y + coin.size
        ) {
          coins++;
          coinsDisplay.textContent = `Monedas: ${coins}`;
          coinObjects.splice(i, 1);
          i--;
        }
      }

      coinObjects = coinObjects.filter(c => c.x + c.size > 0);

      frame++;

      // Aumenta velocidad despuÃ©s de 10 segundos
      const elapsedSeconds = (performance.now() - speedStartTime) / 1000;
      if (elapsedSeconds > 10 && speed < 8) {
        speed = 8;
      }

      if (frame % 5 === 0) {
        score++;
        scoreDisplay.textContent = `Puntos: ${score}`;
        if (score % 100 === 0 && speed < 16) {
          speed += 0.5;
        }
      }

      if (score >= goal) {
        youWin = true;
        winMessage.style.display = "block";
        drawWin();
        return;
      }

      requestAnimationFrame(update);
    }

    // Manejo de teclas
    window.addEventListener("keydown", e => {
      if (e.code === "Space" && mangonio.grounded && !gameOver && !youWin) {
        mangonio.vy = mangonio.jumpPower;
        mangonio.grounded = false;
      }
      if (e.code === "KeyR" && (gameOver || youWin)) {
        resetGame();
      }
    });

    // Cambio de skin desde selector (solo skins desbloqueadas o base)
    skinSelector.addEventListener("change", () => {
      const selected = skinSelector.value;
      if (isSkinOwned(selected) || isBaseSkin(selected)) {
        mangonioImg.src = selected;
      } else {
        alert("No tienes esa skin. CÃ³mprala en la tienda.");
        // Volver al skin anterior
        mangonioImg.src = skinSelector.options[skinSelector.selectedIndex].value;
      }
    });

    // Ayuda para saber si skin es base (del selector original)
    function isBaseSkin(skin) {
      return ["mangonio.png", "mangoniofino.png", "RenÃ©.png"].includes(skin);
    }

    // Ver si skin estÃ¡ desbloqueada
    function isSkinOwned(skin) {
      return storeSkins.some(s => s.img === skin && s.owned);
    }

    // Abrir tienda
    shopBtn.addEventListener("click", () => {
      renderShop();
      shopModal.style.display = "block";
    });

    // Cerrar tienda
    closeShopBtn.addEventListener("click", () => {
      shopModal.style.display = "none";
    });

    // Renderizar tienda
    function renderShop() {
      shopItemsDiv.innerHTML = "";
      storeSkins.forEach(skin => {
        const div = document.createElement("div");
        div.className = "shopItem";

        const img = document.createElement("img");
        img.src = skin.img;

        const spanName = document.createElement("span");
        spanName.textContent = skin.name;

        const spanPrice = document.createElement("span");
        spanPrice.textContent = `${skin.price} monedas`;

        const btn = document.createElement("button");
        btn.className = "buyBtn";

        if (skin.owned) {
          btn.textContent = "Comprado";
          btn.disabled = true;
        } else if (coins < skin.price) {
          btn.textContent = "No tienes monedas";
          btn.disabled = true;
        } else {
          btn.textContent = "Comprar";
          btn.disabled = false;
          btn.addEventListener("click", () => {
            if (coins >= skin.price) {
              coins -= skin.price;
              skin.owned = true;
              coinsDisplay.textContent = `Monedas: ${coins}`;
              renderShop();
              alert(`Compraste la skin ${skin.name}!`);
              // AÃ±adir skin al selector si no existe
              if (![...skinSelector.options].some(o => o.value === skin.img)) {
                const option = document.createElement("option");
                option.value = skin.img;
                option.text = skin.name;
                skinSelector.appendChild(option);
              }
            }
          });
        }

        div.appendChild(img);
        div.appendChild(spanName);
        div.appendChild(spanPrice);
        div.appendChild(btn);
        shopItemsDiv.appendChild(div);
      });
    }

    mangonioImg.onload = () => {
      resetGame();
    };
  </script>
</body>
</html>
