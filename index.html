<script>
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const personajes = {
    "pablito.png": { muerto: "pablito.png" },
    "mangonio.png": { muerto: "mangonio1.png" },
    "mangoniofino.png": { muerto: "mangoniofino.png" },
    "René.png": { muerto: "rene1.png" }
  };

  let seleccion = "pablito.png";
  let personajeImg = new Image();
  personajeImg.src = seleccion;

  let muerto = false;
  let agachado = false;

  const jugador = {
    x: 50,
    y: 150,
    vy: 0,
    width: 50,
    height: 50,
    grounded: true
  };

  const cactus = {
    x: 800,
    y: 150,
    width: 20,
    height: 50
  };

  document.addEventListener("keydown", e => {
    if (e.key === " " && jugador.grounded && !muerto) {
      jugador.vy = -12;
      jugador.grounded = false;
    }
    if (e.key.toLowerCase() === "b") {
      agachado = true;
    }
  });

  document.addEventListener("keyup", e => {
    if (e.key.toLowerCase() === "b") {
      agachado = false;
    }
  });

  function cambiarPersonaje(nombreArchivo) {
    seleccion = nombreArchivo;
    personajeImg.src = seleccion;
    muerto = false;
  }

  function colision(a, b) {
    return (
      a.x < b.x + b.width &&
      a.x + a.width > b.x &&
      a.y < b.y + b.height &&
      a.y + a.height > b.y
    );
  }

  function actualizar() {
    if (!muerto) {
      jugador.vy += 0.6;
      jugador.y += jugador.vy;

      if (jugador.y >= 150) {
        jugador.y = 150;
        jugador.vy = 0;
        jugador.grounded = true;
      }

      cactus.x -= 6;
      if (cactus.x < -20) cactus.x = 800;

      if (colision(jugador, cactus)) {
        muerto = true;
        const imgMuerto = personajes[seleccion]?.muerto;
        if (imgMuerto) personajeImg.src = imgMuerto;
      }
    }
  }

  function dibujar() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Agacharse (reducir altura visual)
    const altura = agachado ? 30 : 50;
    const offset = agachado ? 20 : 0;

    ctx.drawImage(personajeImg, jugador.x, jugador.y + offset, jugador.width, altura);

    ctx.fillStyle = "green";
    ctx.fillRect(cactus.x, cactus.y, cactus.width, cactus.height);
  }

  function bucle() {
    actualizar();
    dibujar();
    requestAnimationFrame(bucle);
  }

  bucle();

  // Cambiar personaje desde fuera (si ya tenías un selector)
  window.cambiarPersonaje = cambiarPersonaje;
</script>
