<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Esquiva Mangonio</title>
  <style>
    body {
      margin: 0;
      background: #b3e0ff; /* azul clarito */
      font-family: Arial, sans-serif;
    }
    #gameContainer {
      position: relative;
      width: 800px;
      height: 400px;
      background: #d4f1f9; /* suelo más claro */
      border: 2px solid #333;
      margin: 0 auto;
      overflow: hidden;
    }
    canvas {
      display: block;
    }
    #skinSelector {
      text-align: center;
      padding: 10px;
    }
    button {
      margin: 0 5px;
      padding: 6px 12px;
      font-weight: bold;
      background-color: #338;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button.selected {
      background-color: #44a;
    }
  </style>
</head>
<body>
<div id="skinSelector">
  <button id="skinMangonio" class="selected">Mangonio</button>
  <button id="skinFino">Mangonio Fino</button>
  <button id="skinRene">René</button>
</div>
<div id="gameContainer">
  <canvas id="gameCanvas" width="800" height="400"></canvas>
</div>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  const groundY = 350;
  let gameOver = false;
  let level = 1;
  let score = 0;
  let shield = 100;
  let obstacles = [];
  let bottles = [];
  let cactusCount = 0;

  const skins = {
    mangonio: { alive: 'mangonio.png', dead: 'mangonio1.png' },
    mangoniofino: { alive: 'mangoniofino.png', dead: 'mangoniofino1.png' },
    rene: { alive: 'rene.png', dead: 'rene1.png' }
  };
  let currentSkin = localStorage.getItem('selectedSkin') || 'mangonio';

  const skinButtons = {
    mangonio: document.getElementById('skinMangonio'),
    mangoniofino: document.getElementById('skinFino'),
    rene: document.getElementById('skinRene'),
  };

  Object.keys(skinButtons).forEach(skin => {
    skinButtons[skin].addEventListener('click', () => {
      currentSkin = skin;
      localStorage.setItem('selectedSkin', currentSkin);
      updateSkinButtons();
    });
  });

  function updateSkinButtons() {
    Object.keys(skinButtons).forEach(skin => {
      skinButtons[skin].classList.toggle('selected', currentSkin === skin);
    });
  }

  const playerImg = new Image();
  const playerDeadImg = new Image();
  playerImg.src = skins[currentSkin].alive;
  playerDeadImg.src = skins[currentSkin].dead;

  let player = {
    x: 100,
    y: groundY - 50,
    width: 50,
    height: 50,
    dy: 0,
    gravity: 0.8,
    jumpStrength: 14.25, // 5% menos que antes
    jumping: false,
    crouching: false,
    alive: true,
    updateSkin: function () {
      playerImg.src = skins[currentSkin].alive;
      playerDeadImg.src = skins[currentSkin].dead;
    }
  };
  player.updateSkin();

  function createObstacle() {
    obstacles.push({
      x: canvas.width,
      y: groundY - 50,
      width: 20,
      height: 50
    });
    cactusCount++;
    if ([2, 3, 4, 5].includes(level) && cactusCount % 5 === 0) {
      bottles.push({
        x: canvas.width,
        y: groundY - 70,
        width: 20,
        height: 30
      });
    }
  }

  function drawObstacle(obs) {
    ctx.fillStyle = 'green';
    ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
    ctx.fillStyle = '#0c0c0c';
    for (let i = 0; i < 6; i++) {
      ctx.beginPath();
      ctx.arc(obs.x + Math.random() * 20, obs.y + Math.random() * 50, 1.5, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function drawBottle(bottle) {
    ctx.fillStyle = 'skyblue';
    ctx.fillRect(bottle.x, bottle.y, bottle.width, bottle.height);
  }

  function drawShieldBar() {
    ctx.fillStyle = 'lightblue';
    ctx.fillRect(10, 10, shield * 2, 10);
    ctx.strokeStyle = 'black';
    ctx.strokeRect(10, 10, 200, 10);
  }

  function drawPlayer() {
    const img = player.alive ? playerImg : playerDeadImg;
    ctx.drawImage(img, player.x, player.y, player.width, player.height);
  }

  function updatePlayer() {
    if (player.crouching) return;
    player.y += player.dy;
    player.dy += player.gravity;

    if (player.y >= groundY - player.height) {
      player.y = groundY - player.height;
      player.dy = 0;
      player.jumping = false;
    }
  }

  function detectCollisions() {
    for (let obs of obstacles) {
      if (
        player.x < obs.x + obs.width &&
        player.x + player.width > obs.x &&
        player.y < obs.y + obs.height &&
        player.y + player.height > obs.y
      ) {
        if (shield > 0) {
          shield -= 20;
          obs.x = -100;
        } else {
          player.alive = false;
          gameOver = true;
        }
      }
    }

    for (let bottle of bottles) {
      if (
        player.x < bottle.x + bottle.width &&
        player.x + player.width > bottle.x &&
        player.y < bottle.y + bottle.height &&
        player.y + player.height > bottle.y
      ) {
        shield = Math.min(shield + 30, 100);
        bottle.x = -100;
      }
    }
  }

  function resetGame() {
    player.alive = true;
    player.updateSkin();
    player.y = groundY - player.height;
    player.dy = 0;
    shield = 100;
    obstacles = [];
    bottles = [];
    cactusCount = 0;
    gameOver = false;
  }

  window.addEventListener('keydown', e => {
    if ((e.code === 'Space' || e.code === 'ArrowUp') && !player.jumping && player.alive) {
      player.dy = -player.jumpStrength;
      player.jumping = true;
    }
    if (e.code === 'ArrowDown' || e.code === 'KeyB') {
      player.crouching = true;
      player.height = 25;
    }
    if (e.code === 'KeyR') resetGame();
    if (e.code === 'KeyT') {
      if (level < 5) level++;
      resetGame();
    }
  });

  window.addEventListener('keyup', e => {
    if (e.code === 'ArrowDown' || e.code === 'KeyB') {
      player.crouching = false;
      player.height = 50;
      player.y = groundY - player.height;
    }
  });

  function update() {
    if (gameOver) return;
    if (Math.random() < 0.02) createObstacle();

    for (let obs of obstacles) obs.x -= 3;
    for (let b of bottles) b.x -= 3;

    obstacles = obstacles.filter(o => o.x + o.width > 0);
    bottles = bottles.filter(b => b.x + b.width > 0);

    updatePlayer();
    detectCollisions();
    score += 0.1;
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#ffd';
    ctx.fillRect(0, groundY, canvas.width, 50);

    drawShieldBar();

    for (let obs of obstacles) drawObstacle(obs);
    for (let b of bottles) drawBottle(b);

    drawPlayer();

    ctx.fillStyle = 'black';
    ctx.fillText(`Nivel: ${level}`, 10, 40);
    ctx.fillText(`Puntaje: ${Math.floor(score)}`, 10, 60);

    if (gameOver) {
      ctx.fillStyle = 'rgba(0,0,0,0.5)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'white';
      ctx.font = '30px Arial';
      ctx.fillText('¡Has perdido! Presiona R para reiniciar', 150, 200);
    }
  }

  function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
  }

  player.updateSkin();
  updateSkinButtons();
  loop();
})();
</script>
</body>
</html>
