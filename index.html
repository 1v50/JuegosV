<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Esquiva Mangonio</title>
  <style>
    body {
      margin: 0;
      background: #def;
      overflow: hidden;
    }
    canvas {
      display: block;
      margin: auto;
      background: #b2ebf2;
      border: 5px solid #333;
    }
    #gameOver, #winMessage {
      position: absolute;
      top: 30%;
      width: 100%;
      text-align: center;
      font-size: 2em;
      color: red;
      display: none;
    }
    #score {
      position: absolute;
      top: 10px;
      left: 20px;
      font-size: 20px;
      font-weight: bold;
    }
    #skinSelector {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      padding: 8px;
    }
  </style>
</head>
<body>
  <div id="gameOver">Haz muerto, Mangonio estÃ¡ muy triste ðŸ˜­<br>Presiona "R" para reiniciar</div>
  <div id="winMessage">Ganaste, Mangonio estÃ¡ orgulloso ðŸ™‰<br>Puntaje mÃ¡ximo alcanzado</div>
  <div id="score">Puntos: 0</div>
  <select id="skinSelector">
    <option value="mangonio.png">Mangonio</option>
    <option value="mangoniofino.png">Mangonio Fino</option>
    <option value="RenÃ©.png">RenÃ©</option>
  </select>
  <canvas id="game" width="800" height="300"></canvas>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreDisplay = document.getElementById("score");
    const gameOverText = document.getElementById("gameOver");
    const winMessage = document.getElementById("winMessage");
    const skinSelector = document.getElementById("skinSelector");

    const mangonioImg = new Image();
    mangonioImg.src = skinSelector.value;

    const goal = 2500;
    const floorHeight = 60;

    let mangonio, obstacles, speed, frame, score, gameOver, youWin;
    let speedStartTime = 0;

    // Estado baterÃ­a (para futuras mejoras)
    let batteryInfo = {
      charging: true,
      level: 1,
      savingMode: false
    };

    // Detectar estado baterÃ­a si estÃ¡ disponible
    if ('getBattery' in navigator) {
      navigator.getBattery().then(battery => {
        function updateBatteryInfo() {
          batteryInfo.charging = battery.charging;
          batteryInfo.level = battery.level; // 0 a 1
          batteryInfo.savingMode = battery.level <= 0.2 && !battery.charging;
          console.log(`BaterÃ­a: ${(battery.level*100).toFixed(0)}%, Cargando: ${battery.charging}, Ahorro: ${batteryInfo.savingMode}`);
        }
        updateBatteryInfo();

        battery.addEventListener('chargingchange', updateBatteryInfo);
        battery.addEventListener('levelchange', updateBatteryInfo);
      });
    } else {
      console.log("API de baterÃ­a no soportada en este navegador");
    }

    function resetGame() {
      mangonio = {
        x: 60,
        y: canvas.height - floorHeight - 60,
        width: 50,
        height: 70,
        vy: 0,
        jumpPower: -13,
        gravity: 0.9,
        grounded: true
      };
      obstacles = [];
      speed = 6;
      frame = 0;
      score = 0;
      gameOver = false;
      youWin = false;
      speedStartTime = performance.now();
      gameOverText.style.display = "none";
      winMessage.style.display = "none";
      scoreDisplay.textContent = "Puntos: 0";
      requestAnimationFrame(update);
    }

    function drawFloor() {
      ctx.fillStyle = "#f5deb3";
      ctx.fillRect(0, canvas.height - floorHeight, canvas.width, floorHeight);
    }

    function drawMangonio() {
      ctx.drawImage(mangonioImg, mangonio.x, mangonio.y, mangonio.width, mangonio.height);
    }

    function drawCactus(cactus) {
      ctx.fillStyle = "#2e8b57";
      ctx.fillRect(cactus.x, cactus.y, cactus.width, cactus.height);
      ctx.fillRect(cactus.x - 10, cactus.y + 10, 8, 20);
      ctx.fillRect(cactus.x + cactus.width, cactus.y + 10, 8, 20);
    }

    function drawWin() {
      ctx.font = "30px Arial";
      ctx.fillStyle = "purple";
      ctx.fillText("ðŸŽ‚", canvas.width / 2 - 15, canvas.height / 2);
      for (let i = 0; i < 100; i++) {
        ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
        ctx.beginPath();
        ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 3, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function update() {
      if (gameOver || youWin) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawFloor();

      mangonio.vy += mangonio.gravity;
      mangonio.y += mangonio.vy;

      if (mangonio.y >= canvas.height - floorHeight - mangonio.height) {
        mangonio.y = canvas.height - floorHeight - mangonio.height;
        mangonio.vy = 0;
        mangonio.grounded = true;
      }

      drawMangonio();

      if (frame % 60 === 0) {
        obstacles.push({
          x: canvas.width,
          y: canvas.height - floorHeight - 50,
          width: 20,
          height: 50
        });
      }

      for (let i = 0; i < obstacles.length; i++) {
        let c = obstacles[i];
        c.x -= speed;
        drawCactus(c);

        if (
          mangonio.x < c.x + c.width &&
          mangonio.x + mangonio.width > c.x &&
          mangonio.y + mangonio.height > c.y
        ) {
          gameOver = true;
          gameOverText.style.display = "block";
          return;
        }
      }

      obstacles = obstacles.filter(c => c.x + c.width > 0);

      frame++;

      // Aumenta velocidad despuÃ©s de 10 segundos
      const elapsedSeconds = (performance.now() - speedStartTime) / 1000;
      if (elapsedSeconds > 10 && speed < 8) {
        speed = 8;
      }

      if (frame % 5 === 0) {
        score++;
        scoreDisplay.textContent = `Puntos: ${score}`;
        if (score % 100 === 0 && speed < 16) {
          speed += 0.5;
        }
      }

      if (score >= goal) {
        youWin = true;
        winMessage.style.display = "block";
        drawWin();
        return;
      }

      requestAnimationFrame(update);
    }

    window.addEventListener("keydown", e => {
      if (e.code === "Space" && mangonio.grounded && !gameOver && !youWin) {
        mangonio.vy = mangonio.jumpPower;
        mangonio.grounded = false;
      }
      if (e.code === "KeyR" && (gameOver || youWin)) {
        resetGame();
      }
    });

    skinSelector.addEventListener("change", () => {
      mangonioImg.src = skinSelector.value;
    });

    mangonioImg.onload = () => {
      resetGame();
    };
  </script>
</body>
</html>
